import{c as x,R as Y,X as Ze,Y as Le,Z as Ye,_ as Xe,q as S,$ as Ke,a0 as et,G as ye,a1 as tt,a2 as W,a3 as Q,a4 as st,a5 as nt,V as ge,a6 as rt,t as _e}from"./three.module-B_E_UEtZ.js";import{G as Se}from"./threeApi-CUz88pwB.js";function Ce(r){let e;try{e=new URL(r,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}function ot(r){Promise.resolve().then(r)}class at{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,o=this.itemList,a=this.callbacks;return o.push(e),n.add(e),s.set(e,Date.now()),a.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,o=this.callbacks;if(s.has(e)){o.get(e)(e);const a=n.indexOf(e);return n.splice(a,1),t.delete(e),s.delete(e),o.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,o=this.usedSet,a=this.callbacks,i=s.length-o.size,l=s.length-t,u=this.unloadPriorityCallback||this.defaultPriorityCallback;if(l>0&&i>0){s.sort((d,p)=>{const m=o.has(d),_=o.has(p);return m&&_?0:!m&&!_?u(p)-u(d):m?1:-1});const h=Math.min(l,i),c=Math.max(t*e,h*e);let f=Math.min(c,i);f=Math.ceil(f);const g=s.splice(0,f);for(let d=0,p=g.length;d<p;d++){const m=g[d];a.get(m)(m),n.delete(m),a.delete(m)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,ot(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class ve{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const o=(...l)=>t(...l).then(s).catch(n),a=this.items,i=this.callbacks;a.push(e),i.set(e,o),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const o=e.pop(),a=t.get(o);t.delete(o),a(o).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const K=0,ee=1,le=2,Z=3,ae=4,ie=6378137,it=1/298.257223563,ct=-(it*ie-ie);function we(r){return r===Z||r===ae}function B(r,e){return r.__lastFrameVisited===e&&r.__used}function ke(r,e){r.__lastFrameVisited!==e&&(r.__lastFrameVisited=e,r.__used=!1,r.__inFrustum=!1,r.__isLeaf=!1,r.__visible=!1,r.__active=!1,r.__error=1/0,r.__distanceFromCamera=1/0,r.__childrenWereVisible=!1,r.__allChildrenLoaded=!1)}function Be(r,e,t){if(ke(r,e),r.__used=!0,t.markUsed(r),r.__contentEmpty){const s=r.children;for(let n=0,o=s.length;n<o;n++)Be(s[n],e,t)}}function Ne(r,e,t){if(r.__contentEmpty&&(!r.__externalTileSet||we(r.__loadingState))){const n=r.children;for(let o=0,a=n.length;o<a;o++){const i=n[o];i.__depthFromRenderedParent=e,Ne(i,e,t)}}else t.requestTileContents(r)}function be(r,e=null,t=null,s=null,n=0){if(e&&e(r,s,n)){t&&t(r,s,n);return}const o=r.children;for(let a=0,i=o.length;a<i;a++)be(o[a],e,t,r,n+1);t&&t(r,s,n)}function De(r,e){const t=e.stats,s=e.frameCount,n=e.errorTarget,o=e.maxDepth,a=e.loadSiblings,i=e.lruCache,l=e.stopAtEmptyTiles;if(ke(r,s),e.tileInView(r)===!1)return!1;if(r.__used=!0,i.markUsed(r),r.__inFrustum=!0,t.inFrustum++,(l||!r.__contentEmpty)&&!r.__externalTileSet&&(e.calculateError(r),r.__error<=n||e.maxDepth>0&&r.__depth+1>=o))return!0;let h=!1;const c=r.children;for(let f=0,g=c.length;f<g;f++){const d=c[f],p=De(d,e);h=h||p}if(h&&a)for(let f=0,g=c.length;f<g;f++){const d=c[f];Be(d,s,i)}return!0}function Ve(r,e){const t=e.stats,s=e.frameCount;if(!B(r,s))return;t.used++;const n=r.children;let o=!1;for(let a=0,i=n.length;a<i;a++){const l=n[a];o=o||B(l,s)}if(!o)r.__isLeaf=!0;else{let a=!1,i=!0;for(let l=0,u=n.length;l<u;l++){const h=n[l];if(Ve(h,e),a=a||h.__wasSetVisible||h.__childrenWereVisible,B(h,s)){const c=h.__allChildrenLoaded||!h.__contentEmpty&&we(h.__loadingState)||h.__externalTileSet&&h.__loadingState===ae;i=i&&c}}r.__childrenWereVisible=a,r.__allChildrenLoaded=i}}function ze(r,e){const t=e.stats,s=e.frameCount;if(!B(r,s))return;const n=r.parent,o=n?n.__depthFromRenderedParent:-1;r.__depthFromRenderedParent=o;const a=e.lruCache;if(r.__isLeaf){r.__depthFromRenderedParent++,r.__loadingState===Z?(r.__inFrustum&&(r.__visible=!0,t.visible++),r.__active=!0,t.active++):!a.isFull()&&(!r.__contentEmpty||r.__externalTileSet)&&e.requestTileContents(r);return}const i=(e.errorTarget+1)*e.errorThreshold,l=r.__error<=i,u=l||r.refine==="ADD",h=!r.__contentEmpty,c=h||r.__externalTileSet,f=we(r.__loadingState)&&c,g=r.__childrenWereVisible,d=r.children,p=r.__allChildrenLoaded;if(u&&h&&r.__depthFromRenderedParent++,u&&!f&&!a.isFull()&&c&&e.requestTileContents(r),(l&&!p&&!g&&f||r.refine==="ADD"&&f)&&(r.__inFrustum&&(r.__visible=!0,t.visible++),r.__active=!0,t.active++),r.refine!=="ADD"&&l&&!p&&f)for(let m=0,_=d.length;m<_;m++){const T=d[m];B(T,s)&&!a.isFull()&&(T.__depthFromRenderedParent=r.__depthFromRenderedParent+1,Ne(T,T.__depthFromRenderedParent,e))}else for(let m=0,_=d.length;m<_;m++){const T=d[m];B(T,s)&&ze(T,e)}}function Ge(r,e){const t=e.frameCount,s=B(r,t);if(s||r.__usedLastFrame){let n=!1,o=!1;s&&(n=r.__active,e.displayActiveTiles?o=r.__active||r.__visible:o=r.__visible),!r.__contentEmpty&&r.__loadingState===Z&&(r.__wasSetActive!==n&&e.setTileActive(r,n),r.__wasSetVisible!==o&&e.setTileVisible(r,o)),r.__wasSetActive=n,r.__wasSetVisible=o,r.__usedLastFrame=s;const a=r.children;for(let i=0,l=a.length;i<l;i++){const u=a[i];Ge(u,e)}}}const Ee=(r,e)=>r.__depth!==e.__depth?r.__depth>e.__depth?-1:1:r.__inFrustum!==e.__inFrustum?r.__inFrustum?1:-1:r.__used!==e.__used?r.__used?1:-1:r.__error!==e.__error?r.__error>e.__error?1:-1:r.__distanceFromCamera!==e.__distanceFromCamera?r.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,lt=r=>1/(r.__depthFromRenderedParent+1);class ht{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new at;t.unloadPriorityCallback=lt;const s=new ve;s.maxJobs=4,s.priorityCallback=Ee;const n=new ve;n.maxJobs=1,n.priorityCallback=Ee,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||be(n.root,e,t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.loadRootTileSet(this.rootURL);return}const o=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,De(o,this),Ve(o,this),ze(o,this),Ge(o,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,s+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[],e.content&&e.content.uri){const o=Ce(e.content.uri),a=!!(o&&o.toLowerCase()==="json");e.__externalTileSet=a,e.__contentEmpty=a}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=K,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,t===null?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===ae&&(t.__loadingState=K)}),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${n.status} : ${n.statusText}`)}).then(n=>{const o=n.asset.version;console.assert(o==="1.0"||o==="0.0",'asset.version is expected to be a string of "1.0" or "0.0"');let a=e.replace(/\/[^\/]*\/?$/,"");return a=new URL(a,window.location.href).toString(),be(n.root,(i,l)=>this.preprocessNode(i,l,a),null,s,s?s.__depth:0),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then(n=>{t[e]=n});return s.catch(n=>{console.error(n),t[e]=n}),t[e]=s,s}}requestTileContents(e){if(e.__loadingState!==K)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,o=this.parseQueue,a=e.__externalTileSet;s.add(e,c=>{c.__loadingState===ee?(c.__loadAbort.abort(),c.__loadAbort=null):a?c.children.length=0:this.disposeTile(c),c.__loadingState===ee?t.downloading--:c.__loadingState===le&&t.parsing--,c.__loadingState=K,c.__loadIndex++,o.remove(c),n.remove(c)}),e.__loadIndex++;const i=e.__loadIndex,l=new AbortController,u=l.signal;t.downloading++,e.__loadAbort=l,e.__loadingState=ee;const h=c=>{e.__loadIndex===i&&(c.name!=="AbortError"?(o.remove(e),n.remove(e),e.__loadingState===le?t.parsing--:e.__loadingState===ee&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(c),e.__loadingState=ae):s.remove(e))};a?n.add(e,c=>{if(c.__loadIndex!==i)return Promise.resolve();const f=this.preprocessURL?this.preprocessURL(c.content.uri):c.content.uri;return this.fetchTileSet(f,Object.assign({signal:u},this.fetchOptions),c)}).then(c=>{e.__loadIndex===i&&(t.downloading--,e.__loadAbort=null,e.__loadingState=Z,e.children.push(c.root))}).catch(h):n.add(e,c=>{if(c.__loadIndex!==i)return Promise.resolve();const f=this.preprocessURL?this.preprocessURL(c.content.uri):c.content.uri;return fetch(f,Object.assign({signal:u},this.fetchOptions))}).then(c=>{if(e.__loadIndex===i){if(c.ok)return c.arrayBuffer();throw new Error(`Failed to load model with error code ${c.status}`)}}).then(c=>{if(e.__loadIndex===i)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=le,o.add(e,f=>{if(f.__loadIndex!==i)return Promise.resolve();const g=f.content.uri,d=Ce(g);return this.parseTile(c,f,d)})}).then(()=>{e.__loadIndex===i&&(t.parsing--,e.__loadingState=Z,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(h)}dispose(){const e=this.lruCache;this.traverse(t=>{e.remove(t)}),this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}function He(r){return new TextDecoder().decode(r)}class ce{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let o=null;if(s!==0){const a=new Uint8Array(e,t,s);o=JSON.parse(He(a))}else o={};this.header=o}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const o=this.header;if(!(e in o))return null;const a=o[e];if(a instanceof Object){if(Array.isArray(a))return a;{const{buffer:i,binOffset:l,binLength:u}=this,h=a.byteOffset||0,c=a.type||n,f=a.componentType||s;if("type"in a&&n&&a.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let g;switch(c){case"SCALAR":g=1;break;case"VEC2":g=2;break;case"VEC3":g=3;break;case"VEC4":g=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}let d;const p=l+h,m=t*g;switch(f){case"BYTE":d=new Int8Array(i,p,m);break;case"UNSIGNED_BYTE":d=new Uint8Array(i,p,m);break;case"SHORT":d=new Int16Array(i,p,m);break;case"UNSIGNED_SHORT":d=new Uint16Array(i,p,m);break;case"INT":d=new Int32Array(i,p,m);break;case"UNSIGNED_INT":d=new Uint32Array(i,p,m);break;case"FLOAT":d=new Float32Array(i,p,m);break;case"DOUBLE":d=new Float64Array(i,p,m);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(p+m*d.BYTES_PER_ELEMENT>l+u)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}else return a}}class xe extends ce{constructor(e,t,s,n,o){super(e,s,n,o),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class X{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function j(r){let e;if(r instanceof DataView?e=r:e=new DataView(r),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class ut extends X{parse(e){const t=new DataView(e),s=j(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const a=t.getUint32(12,!0),i=t.getUint32(16,!0),l=t.getUint32(20,!0),u=t.getUint32(24,!0),h=28,c=e.slice(h,h+a+i),f=new ce(c,0,a,i),g=h+a+i,d=e.slice(g,g+l+u),p=new xe(d,f.getData("BATCH_LENGTH"),0,l,u),m=g+l+u,_=new Uint8Array(e,m,o-m);return{version:n,featureTable:f,batchTable:p,glbBytes:_}}}class je extends ut{constructor(e=Y){super(),this.manager=e,this.adjustmentTransform=new x}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,o)=>{const a=this.manager,i=this.fetchOptions,l=a.getHandler("path.gltf")||new Se(a);i.credentials==="include"&&i.mode==="cors"&&l.setCrossOrigin("use-credentials"),"credentials"in i&&l.setWithCredentials(i.credentials==="include"),i.headers&&l.setRequestHeader(i.headers);let u=this.workingPath;!/[\\/]$/.test(u)&&u.length&&(u+="/");const h=this.adjustmentTransform;l.parse(s,u,c=>{const{batchTable:f,featureTable:g}=t,{scene:d}=c,p=g.getData("RTC_CENTER");p&&(d.position.x+=p[0],d.position.y+=p[1],d.position.z+=p[2]),c.scene.updateMatrix(),c.scene.matrix.multiply(h),c.scene.matrix.decompose(c.scene.position,c.scene.quaternion,c.scene.scale),c.batchTable=f,c.featureTable=g,d.batchTable=f,d.featureTable=g,n(c)},o)})}}class dt extends X{parse(e){const t=new DataView(e),s=j(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const a=t.getUint32(12,!0),i=t.getUint32(16,!0),l=t.getUint32(20,!0),u=t.getUint32(24,!0),h=28,c=e.slice(h,h+a+i),f=new ce(c,0,a,i),g=h+a+i,d=e.slice(g,g+l+u),p=new xe(d,f.getData("BATCH_LENGTH")||f.getData("POINTS_LENGTH"),0,l,u);return Promise.resolve({version:n,featureTable:f,batchTable:p})}}class We extends dt{constructor(e=Y){super(),this.manager=e}parse(e){return super.parse(e).then(t=>{const{featureTable:s}=t,n=s.getData("POINTS_LENGTH"),o=s.getData("POSITION",n,"FLOAT","VEC3"),a=s.getData("RGB",n,"UNSIGNED_BYTE","VEC3");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach(c=>{c in s.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${c}" detected.`)});const i=new Ze;i.setAttribute("position",new Le(o,3,!1));const l=new Ye;l.size=2,l.sizeAttenuation=!1,a!==null&&(i.setAttribute("color",new Le(a,3,!0)),l.vertexColors=!0);const u=new Xe(i,l);t.scene=u,t.scene.featureTable=s;const h=s.getData("RTC_CENTER");return h&&(t.scene.position.x+=h[0],t.scene.position.y+=h[1],t.scene.position.z+=h[2]),t})}}class ft extends X{parse(e){const t=new DataView(e),s=j(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const a=t.getUint32(12,!0),i=t.getUint32(16,!0),l=t.getUint32(20,!0),u=t.getUint32(24,!0),h=t.getUint32(28,!0),c=32,f=e.slice(c,c+a+i),g=new ce(f,0,a,i),d=c+a+i,p=e.slice(d,d+l+u),m=new xe(p,g.getData("INSTANCES_LENGTH"),0,l,u),_=d+l+u,T=new Uint8Array(e,_,o-_);let y=null,L=null;if(h)y=T,L=Promise.resolve();else{const P=this.resolveExternalURL(He(T));L=fetch(P,this.fetchOptions).then(w=>{if(!w.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${P}" with status ${w.status} : ${w.statusText}`);return w.arrayBuffer()}).then(w=>{y=new Uint8Array(w)})}return L.then(()=>({version:n,featureTable:g,batchTable:m,glbBytes:y}))}}const Re=new S,he=new S,ue=new S,Me=new S,de=new et,te=new S,se=new x;class Je extends ft{constructor(e=Y){super(),this.manager=e,this.adjustmentTransform=new x}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,o=t.glbBytes.slice().buffer;return new Promise((a,i)=>{const l=this.fetchOptions,u=this.manager,h=u.getHandler("path.gltf")||new Se(u);l.credentials==="include"&&l.mode==="cors"&&h.setCrossOrigin("use-credentials"),"credentials"in l&&h.setWithCredentials(l.credentials==="include"),l.headers&&h.setRequestHeader(l.headers);let c=this.workingPath;/[\\/]$/.test(c)||(c+="/");const f=this.adjustmentTransform;h.parse(o,c,g=>{const d=s.getData("INSTANCES_LENGTH"),p=s.getData("POSITION",d,"FLOAT","VEC3"),m=s.getData("NORMAL_UP",d,"FLOAT","VEC3"),_=s.getData("NORMAL_RIGHT",d,"FLOAT","VEC3"),T=s.getData("SCALE_NON_UNIFORM",d,"FLOAT","VEC3"),y=s.getData("SCALE",d,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(b=>{b in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${b}" detected.`)});const L=new Map,P=[];g.scene.traverse(b=>{if(b.isMesh){const{geometry:A,material:O}=b,N=new Ke(A,O,d);N.position.copy(b.position),N.rotation.copy(b.rotation),N.scale.copy(b.scale),P.push(N),L.set(b,N)}});const w=new S;for(let b=0;b<d;b++)w.x+=p[b*3+0]/d,w.y+=p[b*3+1]/d,w.z+=p[b*3+2]/d;L.forEach((b,A)=>{const O=A.parent;O&&(O.remove(A),O.add(b),b.updateMatrixWorld(),b.position.copy(w).applyMatrix4(b.matrixWorld))});for(let b=0;b<d;b++){Me.set(p[b*3+0]-w.x,p[b*3+1]-w.y,p[b*3+2]-w.z),m?(he.set(m[b*3+0],m[b*3+1],m[b*3+2]),ue.set(_[b*3+0],_[b*3+1],_[b*3+2]),Re.crossVectors(ue,he).normalize(),se.makeBasis(ue,he,Re),de.setFromRotationMatrix(se)):de.set(0,0,0,1),y?te.setScalar(y[b]):T?te.set(T[b*3+0],T[b*3+1],T[b*3+2]):te.set(1,1,1),se.compose(Me,de,te).multiply(f);for(let A=0,O=P.length;A<O;A++)P[A].setMatrixAt(b,se)}g.batchTable=n,g.featureTable=s,g.scene.batchTable=n,g.scene.featureTable=s,a(g)},i)})})}}class pt extends X{parse(e){const t=new DataView(e),s=j(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const o=t.getUint32(8,!0);console.assert(o===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const a=t.getUint32(12,!0),i=[];let l=16;for(let u=0;u<a;u++){const h=new DataView(e,l,12),c=j(h),f=h.getUint32(4,!0),g=h.getUint32(8,!0),d=new Uint8Array(e,l,g);i.push({type:c,buffer:d,version:f}),l+=g}return{version:n,tiles:i}}}class mt extends pt{constructor(e=Y){super(),this.manager=e,this.adjustmentTransform=new x}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,o=[];for(const a in t.tiles){const{type:i,buffer:l}=t.tiles[a];switch(i){case"b3dm":{const u=l.slice(),h=new je(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(n);const c=h.parse(u.buffer);o.push(c);break}case"pnts":{const u=l.slice(),h=new We(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions;const c=h.parse(u.buffer);o.push(c);break}case"i3dm":{const u=l.slice(),h=new Je(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(n);const c=h.parse(u.buffer);o.push(c);break}}}return Promise.all(o).then(a=>{const i=new ye;return a.forEach(l=>{i.add(l.scene)}),{tiles:a,scene:i}})}}class gt{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class _t extends X{constructor(e=Y){super(),this.manager=e}parse(e){return new Promise((t,s)=>{const n=this.manager,o=this.fetchOptions;let a=n.getHandler("path.gltf")||n.getHandler("path.glb");a||(a=new Se(n),a.register(()=>new gt),o.credentials==="include"&&o.mode==="cors"&&a.setCrossOrigin("use-credentials"),"credentials"in o&&a.setWithCredentials(o.credentials==="include"),o.headers&&a.setRequestHeader(o.headers));let i=a.resourcePath||a.path||this.workingPath;!/[\\/]$/.test(i)&&i.length&&(i+="/"),a.parse(e,i,l=>{t(l)},s)})}}const ne=new x;class bt extends ye{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?ne.copy(this.matrix):ne.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=ne.elements,s=this.matrixWorld.elements;let n=!1;for(let o=0;o<16;o++){const a=t[o],i=s[o];if(Math.abs(a-i)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(ne);const o=this.children;for(let a=0,i=o.length;a<i;a++)o[a].updateMatrixWorld()}}}}function Ie(r){const{x:e,y:t,z:s}=r;r.x=s,r.y=e,r.z=t}function Tt(r){return-r+Math.PI/2}const re=new tt,J=new S,k=new S;class yt{constructor(e=1,t=1,s=1){this.radius=new S(e,t,s)}getCartographicToPosition(e,t,s,n){const o=this.radius;re.set(1,Tt(e),t),J.setFromSpherical(re).normalize(),Ie(J),k.copy(J),k.x*=o.x**2,k.y*=o.y**2,k.z*=o.z**2;const a=Math.sqrt(J.dot(k));return k.divideScalar(a),n.copy(k).addScaledVector(J,s)}getCartographicToNormal(e,t,s){return re.set(1,-e+Math.PI/2,t),s.setFromSpherical(re).normalize(),Ie(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}}const F=Math.PI,oe=F/2,$=new S,D=new S,V=new S,Ue=new x;let q=0;const fe=[];function St(r=!1){return r?(fe[q]||(fe[q]=new S),q++,fe[q-1]):new S}function Pe(){q=0}class wt extends yt{constructor(e,t,s,n=-oe,o=oe,a=0,i=2*F,l=0,u=0){super(e,t,s),this.latStart=n,this.latEnd=o,this.lonStart=a,this.lonEnd=i,this.heightStart=l,this.heightEnd=u}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:o,heightStart:a,heightEnd:i}=this,l=W.mapLinear(.5,0,1,t,s),u=W.mapLinear(.5,0,1,n,o),h=Math.floor(n/oe)*oe,c=[[-F/2,0],[F/2,0],[0,h],[0,h+F/2],[0,h+F],[0,h+3*F/2],[t,o],[s,o],[t,n],[s,n],[0,n],[0,o],[l,u],[t,u],[s,u],[l,n],[l,o]],f=[],g=c.length;for(let d=0;d<=1;d++){const p=W.mapLinear(d,0,1,a,i);for(let m=0,_=g;m<_;m++){const[T,y]=c[m];if(T>=t&&T<=s&&y>=n&&y<=o){const L=St(e);f.push(L),this.getCartographicToPosition(T,y,p,L)}}}return f}getBoundingBox(e,t){Pe();const{latStart:s,latEnd:n,lonStart:o,lonEnd:a}=this;if(n-s<F/2){const u=W.mapLinear(.5,0,1,s,n),h=W.mapLinear(.5,0,1,o,a);this.getCartographicToNormal(u,h,V),D.set(0,0,1),$.crossVectors(D,V),D.crossVectors($,V),t.makeBasis($,D,V)}else $.set(1,0,0),D.set(0,1,0),V.set(0,0,1),t.makeBasis($,D,V);Ue.copy(t).invert();const l=this._getPoints(!0);for(let u=0,h=l.length;u<h;u++)l[u].applyMatrix4(Ue);e.makeEmpty(),e.setFromPoints(l)}getBoundingSphere(e,t){Pe();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const H=new Q,U=new x,Ae=new S,z=new S,G=new st,C=[];function pe(r,e){return r.distance-e.distance}function Te(r,e,t){r.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)})}function $e(r,e,t,s){if(t.has(r))if(Te(r.cached.scene,s,C),C.length>0){C.length>1&&C.sort(pe);const l=C[0];return C.length=0,l}else return null;const n=[],o=r.children;for(let l=0,u=o.length;l<u;l++){const h=o[l],c=h.cached,f=e.matrixWorld;U.copy(f);const g=c.sphere;if(g&&(H.copy(g),H.applyMatrix4(U),!s.ray.intersectsSphere(H)))continue;const d=c.box,p=c.boxTransform;if(d)if(U.multiply(p).invert(),G.copy(s.ray),G.applyMatrix4(U),G.intersectBox(d,Ae)){z.setFromMatrixScale(U);const m=z.x;Math.abs(Math.max(z.x-z.y,z.x-z.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");const _={distance:1/0,tile:null};n.push(_),_.distance=Ae.distanceToSquared(G.origin)*m*m,_.tile=h}else continue}n.sort(pe);let a=1/0,i=null;for(let l=0,u=n.length;l<u;l++){const h=n[l];if(h.distance>a)break;{const f=h.tile,g=f.cached.scene;let d=null;if(t.has(f)?(Te(g,s,C),C.length>0&&(C.length>1&&C.sort(pe),d=C[0])):d=$e(f,e,t,s),d){const p=d.distance*d.distance;p<a&&(a=p,i=d),C.length=0}}}return i}function qe(r,e,t,s,n){const o=r.cached,a=e.matrixWorld;U.copy(a);const i=o.sphere;if(i&&(H.copy(i),H.applyMatrix4(U),!s.ray.intersectsSphere(H)))return;const l=o.box,u=o.boxTransform;if(l&&(U.multiply(u).invert(),G.copy(s.ray).applyMatrix4(U),!G.intersectsBox(l)))return;const h=o.scene;if(t.has(r)){Te(h,s,n);return}const c=r.children;for(let f=0,g=c.length;f<g;f++)qe(c[f],e,t,s,n)}const Qe=Symbol("INITIAL_FRUSTUM_CULLED"),v=new x,me=new x,E=new S,R=new S,M=new S,I=new S,xt=new S(1,0,0),Lt=new S(0,1,0);function Fe(r,e){r.traverse(t=>{t.frustumCulled=t[Qe]&&e})}class Ct extends ht{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{Fe(t,!e)}))}constructor(...e){super(...e),this.group=new bt(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new nt;t.setURLModifier(n=>this.preprocessURL?this.preprocessURL(n):n),this.manager=t;const s=this;this._overridenRaycast=function(n,o){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,o)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,s=t.box,n=t.boxTransform;return s?(e.copy(s),e.applyMatrix4(n),!0):!1}getOrientedBounds(e,t){if(!this.root)return!1;const s=this.root.cached,n=s.box,o=s.boxTransform;return n?(e.copy(n),t.copy(o),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return t?(e.copy(t),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=$e(this.root,this.group,this.activeTiles,e);s&&t.push(s)}else qe(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new ge),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof ge?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{this.onLoadTileSet&&Promise.resolve().then(()=>{this.onLoadTileSet(n,e)})}),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new rt,isOrthographic:!1,sseDenominator:-1,position:new S,invScale:-1,pixelSize:0});me.copy(e.matrixWorld).invert(),E.setFromMatrixScale(me);const o=E.x;Math.abs(Math.max(E.x-E.y,E.x-E.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let a=0,i=n.length;a<i;a++){const l=t[a],u=n[a],h=u.frustum,c=u.position,f=s.get(l);(f.width===0||f.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const g=l.projectionMatrix.elements;if(u.isOrthographic=g[15]===1,u.isOrthographic){const d=2/g[0],p=2/g[5];u.pixelSize=Math.max(p/f.height,d/f.width)}else u.sseDenominator=2/g[5]/f.height;u.invScale=o,v.copy(e.matrixWorld),v.premultiply(l.matrixWorldInverse),v.premultiply(l.projectionMatrix),h.setFromProjectionMatrix(v),c.set(0,0,0),c.applyMatrix4(l.matrixWorld),c.applyMatrix4(me)}super.update()}preprocessNode(e,t,s){super.preprocessNode(e,t,s);const n=new x;if(e.transform){const c=e.transform;for(let f=0;f<16;f++)n.elements[f]=c[f]}else n.identity();t&&n.premultiply(t.cached.transform);const o=new x().copy(n).invert();let a=null,i=null,l=null;if("box"in e.boundingVolume){const c=e.boundingVolume.box;a=new _e,i=new x,l=new x,R.set(c[3],c[4],c[5]),M.set(c[6],c[7],c[8]),I.set(c[9],c[10],c[11]);const f=R.length(),g=M.length(),d=I.length();R.normalize(),M.normalize(),I.normalize(),f===0&&R.crossVectors(M,I),g===0&&M.crossVectors(R,I),d===0&&I.crossVectors(R,M),i.set(R.x,M.x,I.x,c[0],R.y,M.y,I.y,c[1],R.z,M.z,I.z,c[2],0,0,0,1),i.premultiply(n),l.copy(i).invert(),a.min.set(-f,-g,-d),a.max.set(f,g,d)}let u=null;if("sphere"in e.boundingVolume){const c=e.boundingVolume.sphere;u=new Q,u.center.set(c[0],c[1],c[2]),u.radius=c[3],u.applyMatrix4(n)}else if("box"in e.boundingVolume){const c=e.boundingVolume.box;u=new Q,a.getBoundingSphere(u),u.center.set(c[0],c[1],c[2]),u.applyMatrix4(n)}let h=null;if("region"in e.boundingVolume){const c=e.boundingVolume.region,[f,g,d,p,m,_]=c;h=new wt(ie,ie,ct,g,p,f,d,m,_),u===null&&(u=new Q,h.getBoundingSphere(u)),a===null&&(a=new _e,i=new x,l=new x,h.getBoundingBox(a,i),l.copy(i).invert())}e.cached={loadIndex:0,transform:n,transformInverse:o,active:!1,inFrustum:[],box:a,boxTransform:i,boxTransformInverse:l,sphere:u,region:h,scene:null,geometry:null,material:null}}parseTile(e,t,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const o=t.content.uri.split(/[\\\/]/g);o.pop();const a=o.join("/"),i=this.fetchOptions,l=this.manager,u=t._loadIndex;let h=null;const c=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",f=t.cached,g=f.transform;switch(c.toLowerCase()){case"x":v.makeRotationAxis(Lt,-Math.PI/2);break;case"y":v.makeRotationAxis(xt,Math.PI/2);break;case"z":v.identity();break}const d=j(e)||s;switch(d){case"b3dm":{const m=new je(l);m.workingPath=a,m.fetchOptions=i,m.adjustmentTransform.copy(v),h=m.parse(e).then(_=>_.scene);break}case"pnts":{const m=new We(l);m.workingPath=a,m.fetchOptions=i,h=m.parse(e).then(_=>_.scene);break}case"i3dm":{const m=new Je(l);m.workingPath=a,m.fetchOptions=i,m.adjustmentTransform.copy(v),h=m.parse(e).then(_=>_.scene);break}case"cmpt":{const m=new mt(l);m.workingPath=a,m.fetchOptions=i,m.adjustmentTransform.copy(v),h=m.parse(e).then(_=>_.scene);break}case"gltf":case"glb":const p=new _t(l);p.workingPath=a,p.fetchOptions=i,h=p.parse(e).then(m=>m.scene);break;default:console.warn(`TilesRenderer: Content type "${d}" not supported.`),h=Promise.resolve(null);break}return h.then(p=>{if(t._loadIndex!==u)return;p.updateMatrix(),(d==="glb"||d==="gltf")&&p.matrix.multiply(v),p.matrix.premultiply(g),p.matrix.decompose(p.position,p.quaternion,p.scale),p.traverse(y=>{y[Qe]=y.frustumCulled}),Fe(p,!this.autoDisableRendererCulling),f.scene=p,p.traverse(y=>{y.raycast=this._overridenRaycast});const m=[],_=[],T=[];p.traverse(y=>{if(y.geometry&&_.push(y.geometry),y.material){const L=y.material;m.push(y.material);for(const P in L){const w=L[P];w&&w.isTexture&&T.push(w)}}}),f.materials=m,f.geometry=_,f.textures=T,this.onLoadModel&&this.onLoadModel(p,t)})}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,o=t.textures,a=t.scene.parent;for(let i=0,l=n.length;i<l;i++)n[i].dispose();for(let i=0,l=s.length;i<l;i++)s[i].dispose();for(let i=0,l=o.length;i<l;i++)o[i].dispose();a&&a.remove(t.scene),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,o=this.group;t?(o.add(s),n.add(e),s.updateMatrixWorld(!0)):(o.remove(s),n.delete(e)),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,o=this.cameraInfo,a=t.sphere,i=t.box,l=t.boxTransformInverse,u=t.transformInverse,h=i&&l;let c=-1/0,f=1/0;for(let g=0,d=n.length;g<d;g++){if(!s[g])continue;const p=o[g],m=p.invScale;let _;if(p.isOrthographic){const T=p.pixelSize;_=e.geometricError/(T*m)}else{E.copy(p.position);let T;h?(E.applyMatrix4(l),T=i.distanceToPoint(E)):(E.applyMatrix4(u),T=Math.max(a.distanceToPoint(E),0));const y=T*m,L=p.sseDenominator;_=e.geometricError/(y*L),f=Math.min(f,y)}c=Math.max(c,_)}e.__distanceFromCamera=f,e.__error=c}tileInView(e){const t=e.cached,s=t.sphere,n=t.inFrustum;if(s){const o=this.cameraInfo;let a=!1;for(let i=0,l=o.length;i<l;i++)o[i].frustum.intersectsSphere(s)?(a=!0,n[i]=!0):n[i]=!1;return a}return!0}}let Oe=new _e,vt=new Q;const It=r=>{r.update()},Ut=(r,e,t,s,n)=>{const o=new Ct(t);o.setCamera(r),o.setResolutionFromRenderer(r,e),o.onLoadModel=function(i){i.traverse(l=>{l.isMesh&&(l.material.transparent=!0,l.uniformHigh=Et(l.material,n))})},o.onLoadTileSet=i=>{o.getBounds(Oe)?(Oe.getCenter(o.group.position),o.group.position.multiplyScalar(-1)):o.getBoundingSphere(vt)&&o.group.position.multiplyScalar(-1)};const a=new ye;return a.add(o.group),a.rotation.set(5.5865,0,12.105),s(a),o};function Et(r,e){const t={highlightedBatchId:{value:-1},time:{type:"f",value:0},resolution:{type:"v2",value:new ge(e.clientWidth,e.clientHeight)}};return r.onBeforeCompile=s=>{s.uniforms.highlightedBatchId=t.highlightedBatchId,s.uniforms.time=t.time,s.uniforms.resolution=t.resolution,s.vertexShader=`
			attribute float _batchid;
			varying float batchid;
		`+s.vertexShader.replace(/#include <uv_vertex>/,`
			#include <uv_vertex>
			batchid = _batchid;
			`),s.fragmentShader=`
			varying float batchid;
			uniform float highlightedBatchId;
            uniform float time; 
		`+s.fragmentShader.replace(/vec4 diffuseColor = vec4\( diffuse, opacity \);/,`
			vec4 diffuseColor =
				abs( batchid - highlightedBatchId ) < 0.5 ?
                vec4(0.,0.,0.0,0.0) :
				vec4( diffuse, opacity );
			`)},t}export{It as T,Ut as l};
