import{c as C,R as $,X as mt,q as y,Y as gt,Z as j,C as _t,_ as bt,$ as Tt,a0 as yt,G as we,a1 as xe,a2 as $e,a3 as St,t as Je,a4 as Qe,a5 as ve,a6 as z,a7 as wt,a8 as xt,a9 as vt,aa as Lt,V as Se}from"./three.module-uvJlERpA.js";import{G as Le}from"./threeApi-VrTM92mv.js";function Pe(r){let e;try{e=new URL(r,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}class Ct{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,o=this.itemList,i=this.callbacks;return o.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,o=this.callbacks;if(s.has(e)){o.get(e)(e);const i=n.indexOf(e);return n.splice(i,1),t.delete(e),s.delete(e),o.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,o=this.usedSet,i=this.callbacks,a=s.length-o.size,c=s.length-t,h=this.unloadPriorityCallback||this.defaultPriorityCallback;if(c>0&&a>0){s.sort((d,g)=>{const p=o.has(d),_=o.has(g);return p&&_?0:!p&&!_?h(g)-h(d):p?1:-1});const u=Math.min(c,a),l=Math.max(t*e,u*e);let f=Math.min(l,a);f=Math.ceil(f);const m=s.splice(0,f);for(let d=0,g=m.length;d<g;d++){const p=m[d];i.get(p)(p),n.delete(p),i.delete(p)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class Me{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const o=(...c)=>t(...c).then(s).catch(n),i=this.items,a=this.callbacks;i.push(e),a.set(e,o),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const o=e.pop(),i=t.get(o);t.delete(o),i(o).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const Q=0,Z=1,he=2,W=3,ae=4,ce=6378137,Et=1/298.257223563,Pt=-(Et*ce-ce);function Ce(r){return r===W||r===ae}function D(r,e){return r.__lastFrameVisited===e&&r.__used}function Ze(r,e){r.__lastFrameVisited!==e&&(r.__lastFrameVisited=e,r.__used=!1,r.__inFrustum=!1,r.__isLeaf=!1,r.__visible=!1,r.__active=!1,r.__error=1/0,r.__distanceFromCamera=1/0,r.__childrenWereVisible=!1,r.__allChildrenLoaded=!1)}function Ye(r,e,t,s){if(s.ensureChildrenArePreprocessed(r),Ze(r,e),r.__used=!0,t.markUsed(r),r.__contentEmpty){const n=r.children;for(let o=0,i=n.length;o<i;o++)Ye(n[o],e,t,s)}}function Xe(r,e,t){if(t.ensureChildrenArePreprocessed(r),r.__contentEmpty&&(!r.__externalTileSet||Ce(r.__loadingState))){const n=r.children;for(let o=0,i=n.length;o<i;o++){const a=n[o];a.__depthFromRenderedParent=e,Xe(a,e,t)}}else t.requestTileContents(r)}function Ke(r,e=null,t=null,s=null,n=0){if(e&&e(r,s,n)){t&&t(r,s,n);return}const o=r.children;for(let i=0,a=o.length;i<a;i++)Ke(o[i],e,t,r,n+1);t&&t(r,s,n)}function et(r,e){e.ensureChildrenArePreprocessed(r);const t=e.stats,s=e.frameCount,n=e.errorTarget,o=e.maxDepth,i=e.loadSiblings,a=e.lruCache,c=e.stopAtEmptyTiles;if(Ze(r,s),e.tileInView(r)===!1)return!1;if(r.__used=!0,a.markUsed(r),r.__inFrustum=!0,t.inFrustum++,(c||!r.__contentEmpty)&&!r.__externalTileSet&&(e.calculateError(r),r.__error<=n||e.maxDepth>0&&r.__depth+1>=o))return!0;let u=!1;const l=r.children;for(let f=0,m=l.length;f<m;f++){const d=l[f],g=et(d,e);u=u||g}if(u&&i)for(let f=0,m=l.length;f<m;f++){const d=l[f];Ye(d,s,a,e)}return!0}function tt(r,e){const t=e.stats,s=e.frameCount;if(!D(r,s))return;t.used++;const n=r.children;let o=!1;for(let i=0,a=n.length;i<a;i++){const c=n[i];o=o||D(c,s)}if(!o)r.__isLeaf=!0;else{let i=!1,a=!0;for(let c=0,h=n.length;c<h;c++){const u=n[c];if(tt(u,e),i=i||u.__wasSetVisible||u.__childrenWereVisible,D(u,s)){const l=u.__allChildrenLoaded||!u.__contentEmpty&&Ce(u.__loadingState)||!u.__externalTileSet&&u.__contentEmpty&&u.children.length===0||u.__externalTileSet&&u.__loadingState===ae;a=a&&l}}r.__childrenWereVisible=i,r.__allChildrenLoaded=a}}function st(r,e){const t=e.stats,s=e.frameCount;if(!D(r,s))return;const n=r.parent,o=n?n.__depthFromRenderedParent:-1;r.__depthFromRenderedParent=o;const i=e.lruCache;if(r.__isLeaf){r.__depthFromRenderedParent++,r.__loadingState===W?(r.__inFrustum&&(r.__visible=!0,t.visible++),r.__active=!0,t.active++):!i.isFull()&&(!r.__contentEmpty||r.__externalTileSet)&&e.requestTileContents(r);return}const a=(e.errorTarget+1)*e.errorThreshold,c=r.__error<=a,h=c||r.refine==="ADD",u=!r.__contentEmpty,l=u||r.__externalTileSet,f=Ce(r.__loadingState)&&l,m=r.__childrenWereVisible,d=r.children,g=r.__allChildrenLoaded;if(h&&u&&r.__depthFromRenderedParent++,h&&!f&&!i.isFull()&&l&&e.requestTileContents(r),(c&&!g&&!m&&f||r.refine==="ADD"&&f)&&(r.__inFrustum&&(r.__visible=!0,t.visible++),r.__active=!0,t.active++),r.refine!=="ADD"&&c&&!g&&f)for(let p=0,_=d.length;p<_;p++){const T=d[p];D(T,s)&&!i.isFull()&&(T.__depthFromRenderedParent=r.__depthFromRenderedParent+1,Xe(T,T.__depthFromRenderedParent,e))}else for(let p=0,_=d.length;p<_;p++){const T=d[p];D(T,s)&&st(T,e)}}function nt(r,e){const t=e.frameCount,s=D(r,t);if(s||r.__usedLastFrame){let n=!1,o=!1;s&&(n=r.__active,e.displayActiveTiles?o=r.__active||r.__visible:o=r.__visible),!r.__contentEmpty&&r.__loadingState===W&&(r.__wasSetActive!==n&&e.setTileActive(r,n),r.__wasSetVisible!==o&&e.setTileVisible(r,o)),r.__wasSetActive=n,r.__wasSetVisible=o,r.__usedLastFrame=s;const i=r.children;for(let a=0,c=i.length;a<c;a++){const h=i[a];nt(h,e)}}}const Ae=(r,e)=>r.__depth!==e.__depth?r.__depth>e.__depth?-1:1:r.__inFrustum!==e.__inFrustum?r.__inFrustum?1:-1:r.__used!==e.__used?r.__used?1:-1:r.__error!==e.__error?r.__error>e.__error?1:-1:r.__distanceFromCamera!==e.__distanceFromCamera?r.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,Mt=r=>1/(r.__depthFromRenderedParent+1);class At{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new Ct;t.unloadPriorityCallback=Mt;const s=new Me;s.maxJobs=4,s.priorityCallback=Ae;const n=new Me;n.maxJobs=1,n.priorityCallback=Ae,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||Ke(n.root,(o,...i)=>(this.ensureChildrenArePreprocessed(o),e?e(o,...i):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.loadRootTileSet(this.rootURL);return}const o=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,et(o,this),tt(o,this),st(o,this),nt(o,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const o=Pe(e.content.uri),i=!!(o&&o.toLowerCase()==="json");e.__externalTileSet=i,e.__contentEmpty=i}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=Q,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,s===null?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.refine=e.refine||s.refine),e.__basePath=t}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const o=t[s];if("__depth"in o)break;this.preprocessNode(o,e.__basePath,e)}}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===ae&&(t.__loadingState=Q)}),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${n.status} : ${n.statusText}`)}).then(n=>{const o=n.asset.version,[i,a]=o.split(".").map(h=>parseInt(h));console.assert(i<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),i===1&&a>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let c=e.replace(/\/[^\/]*\/?$/,"");return c=new URL(c,window.location.href).toString(),this.preprocessNode(n.root,c,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then(n=>{t[e]=n});return s.catch(n=>{console.error(n),t[e]=n}),t[e]=s,s}}requestTileContents(e){if(e.__loadingState!==Q)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,o=this.parseQueue,i=e.__externalTileSet;s.add(e,l=>{l.__loadingState===Z?(l.__loadAbort.abort(),l.__loadAbort=null):i?l.children.length=0:this.disposeTile(l),l.__loadingState===Z?t.downloading--:l.__loadingState===he&&t.parsing--,l.__loadingState=Q,l.__loadIndex++,o.remove(l),n.remove(l)}),e.__loadIndex++;const a=e.__loadIndex,c=new AbortController,h=c.signal;t.downloading++,e.__loadAbort=c,e.__loadingState=Z;const u=l=>{e.__loadIndex===a&&(l.name!=="AbortError"?(o.remove(e),n.remove(e),e.__loadingState===he?t.parsing--:e.__loadingState===Z&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(l),e.__loadingState=ae):s.remove(e))};i?n.add(e,l=>{if(l.__loadIndex!==a)return Promise.resolve();const f=this.preprocessURL?this.preprocessURL(l.content.uri):l.content.uri;return this.fetchTileSet(f,Object.assign({signal:h},this.fetchOptions),l)}).then(l=>{e.__loadIndex===a&&(t.downloading--,e.__loadAbort=null,e.__loadingState=W,e.children.push(l.root))}).catch(u):n.add(e,l=>{if(l.__loadIndex!==a)return Promise.resolve();const f=this.preprocessURL?this.preprocessURL(l.content.uri):l.content.uri;return fetch(f,Object.assign({signal:h},this.fetchOptions))}).then(l=>{if(e.__loadIndex===a){if(l.ok)return l.arrayBuffer();throw new Error(`Failed to load model with error code ${l.status}`)}}).then(l=>{if(e.__loadIndex===a)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=he,o.add(e,f=>{if(f.__loadIndex!==a)return Promise.resolve();const m=f.content.uri,d=Pe(m);return this.parseTile(l,f,d)})}).then(()=>{e.__loadIndex===a&&(t.parsing--,e.__loadingState=W,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(u)}dispose(){const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}const It=new TextDecoder;function ot(r){return It.decode(r)}class ue{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let o=null;if(s!==0){const i=new Uint8Array(e,t,s);o=JSON.parse(ot(i))}else o={};this.header=o}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const o=this.header;if(!(e in o))return null;const i=o[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:a,binOffset:c,binLength:h}=this,u=i.byteOffset||0,l=i.type||n,f=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let m;switch(l){case"SCALAR":m=1;break;case"VEC2":m=2;break;case"VEC3":m=3;break;case"VEC4":m=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}let d;const g=c+u,p=t*m;switch(f){case"BYTE":d=new Int8Array(a,g,p);break;case"UNSIGNED_BYTE":d=new Uint8Array(a,g,p);break;case"SHORT":d=new Int16Array(a,g,p);break;case"UNSIGNED_SHORT":d=new Uint16Array(a,g,p);break;case"INT":d=new Int32Array(a,g,p);break;case"UNSIGNED_INT":d=new Uint32Array(a,g,p);break;case"FLOAT":d=new Float32Array(a,g,p);break;case"DOUBLE":d=new Float64Array(a,g,p);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(g+p*d.BYTES_PER_ELEMENT>c+h)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}else return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class Ee extends ue{constructor(e,t,s,n,o){super(e,s,n,o),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class J{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function G(r){let e;if(r instanceof DataView?e=r:e=new DataView(r),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class Rt extends J{parse(e){const t=new DataView(e),s=G(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),u=28,l=e.slice(u,u+i+a),f=new ue(l,0,i,a),m=u+i+a,d=e.slice(m,m+c+h),g=new Ee(d,f.getData("BATCH_LENGTH"),0,c,h),p=m+c+h,_=new Uint8Array(e,p,o-p);return{version:n,featureTable:f,batchTable:g,glbBytes:_}}}class rt extends Rt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new C}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,o)=>{const i=this.manager,a=this.fetchOptions,c=i.getHandler("path.gltf")||new Le(i);a.credentials==="include"&&a.mode==="cors"&&c.setCrossOrigin("use-credentials"),"credentials"in a&&c.setWithCredentials(a.credentials==="include"),a.headers&&c.setRequestHeader(a.headers);let h=this.workingPath;!/[\\/]$/.test(h)&&h.length&&(h+="/");const u=this.adjustmentTransform;c.parse(s,h,l=>{const{batchTable:f,featureTable:m}=t,{scene:d}=l,g=m.getData("RTC_CENTER");g&&(d.position.x+=g[0],d.position.y+=g[1],d.position.z+=g[2]),l.scene.updateMatrix(),l.scene.matrix.multiply(u),l.scene.matrix.decompose(l.scene.position,l.scene.quaternion,l.scene.scale),l.batchTable=f,l.featureTable=m,d.batchTable=f,d.featureTable=m,n(l)},o)})}}class Ot extends J{parse(e){const t=new DataView(e),s=G(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),u=28,l=e.slice(u,u+i+a),f=new ue(l,0,i,a),m=u+i+a,d=e.slice(m,m+c+h),g=new Ee(d,f.getData("BATCH_LENGTH")||f.getData("POINTS_LENGTH"),0,c,h);return Promise.resolve({version:n,featureTable:f,batchTable:g})}}function Ut(r){const e=r>>11,t=r>>5&63,s=r&31,n=Math.round(e/31*255),o=Math.round(t/63*255),i=Math.round(s/31*255);return[n,o,i]}const Ie={RGB:"color",POSITION:"position"};class it extends Ot{constructor(e=$){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s,batchTable:n}=t,o=new mt,i=s.header.extensions,a=new y;let c;if(i&&i["3DTILES_draco_point_compression"]){const{byteOffset:l,byteLength:f,properties:m}=i["3DTILES_draco_point_compression"],d=this.manager.getHandler("draco.drc");if(d==null)throw new Error("PNTSLoader: dracoLoader not available.");const g={};for(const T in m)if(T in Ie&&T in m){const x=Ie[T];g[x]=m[T]}const p={attributeIDs:g,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},_=s.getBuffer(l,f);c=await d.decodeGeometry(_,p),c.attributes.color&&(o.vertexColors=!0)}else{const l=s.getData("POINTS_LENGTH"),f=s.getData("POSITION",l,"FLOAT","VEC3"),m=s.getData("RGB",l,"UNSIGNED_BYTE","VEC3"),d=s.getData("RGBA",l,"UNSIGNED_BYTE","VEC4"),g=s.getData("RGB565",l,"UNSIGNED_SHORT","SCALAR"),p=s.getData("CONSTANT_RGBA",l,"UNSIGNED_BYTE","VEC4"),_=s.getData("POSITION_QUANTIZED",l,"UNSIGNED_SHORT","VEC3"),T=s.getData("QUANTIZED_VOLUME_SCALE",l,"FLOAT","VEC3"),x=s.getData("QUANTIZED_VOLUME_OFFSET",l,"FLOAT","VEC3");if(c=new gt,_){const w=new Float32Array(l*3);for(let v=0;v<l;v++)for(let S=0;S<3;S++){const b=3*v+S;w[b]=_[b]/65535*T[S]}a.x=x[0],a.y=x[1],a.z=x[2],c.setAttribute("position",new j(w,3,!1))}else c.setAttribute("position",new j(f,3,!1));if(d!==null)c.setAttribute("color",new j(d,4,!0)),o.vertexColors=!0,o.transparent=!0,o.depthWrite=!1;else if(m!==null)c.setAttribute("color",new j(m,3,!0)),o.vertexColors=!0;else if(g!==null){const w=new Uint8Array(l*3);for(let v=0;v<l;v++){const S=Ut(g[v]);for(let b=0;b<3;b++){const L=3*v+b;w[L]=S[b]}}c.setAttribute("color",new j(w,3,!0)),o.vertexColors=!0}else if(p!==null){const w=new _t(p[0],p[1],p[2]);o.color=w;const v=p[3]/255;v<1&&(o.opacity=v,o.transparent=!0,o.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach(l=>{l in s.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${l}" detected.`)});const h=new bt(c,o);h.position.copy(a),t.scene=h,t.scene.featureTable=s,t.scene.batchTable=n;const u=s.getData("RTC_CENTER");return u&&(t.scene.position.x+=u[0],t.scene.position.y+=u[1],t.scene.position.z+=u[2]),t})}}class Bt extends J{parse(e){const t=new DataView(e),s=G(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const o=t.getUint32(8,!0);console.assert(o===e.byteLength);const i=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),u=t.getUint32(28,!0),l=32,f=e.slice(l,l+i+a),m=new ue(f,0,i,a),d=l+i+a,g=e.slice(d,d+c+h),p=new Ee(g,m.getData("INSTANCES_LENGTH"),0,c,h),_=d+c+h,T=new Uint8Array(e,_,o-_);let x=null,w=null;if(u)x=T,w=Promise.resolve();else{const v=this.resolveExternalURL(ot(T));w=fetch(v,this.fetchOptions).then(S=>{if(!S.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${v}" with status ${S.status} : ${S.statusText}`);return S.arrayBuffer()}).then(S=>{x=new Uint8Array(S)})}return w.then(()=>({version:n,featureTable:m,batchTable:p,glbBytes:x}))}}const Re=new y,de=new y,fe=new y,Oe=new y,pe=new yt,Y=new y,X=new C;class at extends Bt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new C}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,o=t.glbBytes.slice().buffer;return new Promise((i,a)=>{const c=this.fetchOptions,h=this.manager,u=h.getHandler("path.gltf")||new Le(h);c.credentials==="include"&&c.mode==="cors"&&u.setCrossOrigin("use-credentials"),"credentials"in c&&u.setWithCredentials(c.credentials==="include"),c.headers&&u.setRequestHeader(c.headers);let l=this.workingPath;/[\\/]$/.test(l)||(l+="/");const f=this.adjustmentTransform;u.parse(o,l,m=>{const d=s.getData("INSTANCES_LENGTH"),g=s.getData("POSITION",d,"FLOAT","VEC3"),p=s.getData("NORMAL_UP",d,"FLOAT","VEC3"),_=s.getData("NORMAL_RIGHT",d,"FLOAT","VEC3"),T=s.getData("SCALE_NON_UNIFORM",d,"FLOAT","VEC3"),x=s.getData("SCALE",d,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(b=>{b in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${b}" detected.`)});const w=new Map,v=[];m.scene.traverse(b=>{if(b.isMesh){const{geometry:L,material:E}=b,M=new Tt(L,E,d);M.position.copy(b.position),M.rotation.copy(b.rotation),M.scale.copy(b.scale),v.push(M),w.set(b,M)}});const S=new y;for(let b=0;b<d;b++)S.x+=g[b*3+0]/d,S.y+=g[b*3+1]/d,S.z+=g[b*3+2]/d;w.forEach((b,L)=>{const E=L.parent;E&&(E.remove(L),E.add(b),b.updateMatrixWorld(),b.position.copy(S).applyMatrix4(b.matrixWorld))});for(let b=0;b<d;b++){Oe.set(g[b*3+0]-S.x,g[b*3+1]-S.y,g[b*3+2]-S.z),p?(de.set(p[b*3+0],p[b*3+1],p[b*3+2]),fe.set(_[b*3+0],_[b*3+1],_[b*3+2]),Re.crossVectors(fe,de).normalize(),X.makeBasis(fe,de,Re),pe.setFromRotationMatrix(X)):pe.set(0,0,0,1),x?Y.setScalar(x[b]):T?Y.set(T[b*3+0],T[b*3+1],T[b*3+2]):Y.set(1,1,1),X.compose(Oe,pe,Y).multiply(f);for(let L=0,E=v.length;L<E;L++)v[L].setMatrixAt(b,X)}m.batchTable=n,m.featureTable=s,m.scene.batchTable=n,m.scene.featureTable=s,i(m)},a)})})}}class Dt extends J{parse(e){const t=new DataView(e),s=G(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const o=t.getUint32(8,!0);console.assert(o===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),a=[];let c=16;for(let h=0;h<i;h++){const u=new DataView(e,c,12),l=G(u),f=u.getUint32(4,!0),m=u.getUint32(8,!0),d=new Uint8Array(e,c,m);a.push({type:l,buffer:d,version:f}),c+=m}return{version:n,tiles:a}}}class Ft extends Dt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new C}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,o=[];for(const i in t.tiles){const{type:a,buffer:c}=t.tiles[i];switch(a){case"b3dm":{const h=c.slice(),u=new rt(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions,u.adjustmentTransform.copy(n);const l=u.parse(h.buffer);o.push(l);break}case"pnts":{const h=c.slice(),u=new it(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions;const l=u.parse(h.buffer);o.push(l);break}case"i3dm":{const h=c.slice(),u=new at(s);u.workingPath=this.workingPath,u.fetchOptions=this.fetchOptions,u.adjustmentTransform.copy(n);const l=u.parse(h.buffer);o.push(l);break}}}return Promise.all(o).then(i=>{const a=new we;return i.forEach(c=>{a.add(c.scene)}),{tiles:i,scene:a}})}}class Nt{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class kt extends J{constructor(e=$){super(),this.manager=e}parse(e){return new Promise((t,s)=>{const n=this.manager,o=this.fetchOptions;let i=n.getHandler("path.gltf")||n.getHandler("path.glb");i||(i=new Le(n),i.register(()=>new Nt)),o.credentials==="include"&&o.mode==="cors"&&i.setCrossOrigin("use-credentials"),"credentials"in o&&i.setWithCredentials(o.credentials==="include"),o.headers&&(console.log(o),i.setRequestHeader(o.headers));let a=i.resourcePath||i.path||this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),i.parse(e,a,c=>{t(c)},s)})}}const K=new C;class Vt extends we{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?K.copy(this.matrix):K.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=K.elements,s=this.matrixWorld.elements;let n=!1;for(let o=0;o<16;o++){const i=t[o],a=s[o];if(Math.abs(i-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(K);const o=this.children;for(let i=0,a=o.length;i<a;i++)o[i].updateMatrixWorld()}}}}const zt=parseInt($e)<165,le=new C,ct=new xe,me=new y,ie=[];function lt(r,e){return r.distance-e.distance}function ut(r,e,t){zt?(r.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)}),ie.sort(lt)):e.intersectObject(r,!0,t)}function Gt(r,e){ut(r,e,ie);const t=ie[0]||null;return ie.length=0,t}function ht(r,e,t,s=null){const{group:n,activeTiles:o}=r;r.ensureChildrenArePreprocessed(e),s===null&&(s=ct,le.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(le));const i=[],a=e.children;for(let u=0,l=a.length;u<l;u++){const f=a[u];if(!f.__used)continue;f.cached.boundingVolume.intersectRay(s,me)!==null&&(me.applyMatrix4(n.matrixWorld),i.push({distance:me.distanceToSquared(t.ray.origin),tile:f}))}i.sort(lt);let c=null,h=1/0;if(o.has(e)){const u=Gt(e.cached.scene,t);u&&(c=u,h=u.distance*u.distance)}for(let u=0,l=i.length;u<l;u++){const f=i[u],m=f.distance,d=f.tile;if(m>h)break;const g=ht(r,d,t,s);if(g){const p=g.distance*g.distance;p<h&&(c=g,h=p)}}return c}function dt(r,e,t,s,n=null){const{group:o,activeTiles:i}=r,{scene:a,boundingVolume:c}=e.cached;if(r.ensureChildrenArePreprocessed(e),n===null&&(n=ct,le.copy(o.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(le)),!e.__used||!c.intersectsRay(n))return;i.has(e)&&ut(a,t,s);const h=e.children;for(let u=0,l=h.length;u<l;u++)dt(r,h[u],t,s,n)}const ee=new y,te=new y,A=new y;class Ue{constructor(e=new Je,t=new C){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new C,this.points=new Array(8).fill().map(()=>new y),this.planes=new Array(6).fill().map(()=>new St)}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:o,max:i}=n;let a=0;for(let c=-1;c<=1;c+=2)for(let h=-1;h<=1;h+=2)for(let u=-1;u<=1;u+=2)e[a].set(c<0?o.x:i.x,h<0?o.y:i.y,u<0?o.z:i.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){ee.copy(this.box.min).applyMatrix4(this.transform),te.copy(this.box.max).applyMatrix4(this.transform),A.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(A,ee),this.planes[1].setFromNormalAndCoplanarPoint(A,te).negate(),A.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(A,ee),this.planes[3].setFromNormalAndCoplanarPoint(A,te).negate(),A.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(A,ee),this.planes[5].setFromNormalAndCoplanarPoint(A,te).negate()}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const o=s[n];let i=-1/0;for(let a=0;a<8;a++){const c=t[a],h=o.distanceToPoint(c);i=i<h?h:i}if(i<0)return!1}for(let n=0;n<6;n++){const o=this.planes[n];let i=-1/0;for(let a=0;a<8;a++){const c=e.points[a],h=o.distanceToPoint(c);i=i<h?h:i}if(i<0)return!1}return!0}}new Qe;new y;function jt(r){const{x:e,y:t,z:s}=r;r.x=s,r.y=e,r.z=t}function Ht(r){return-r+Math.PI/2}const Be=new Qe,U=new y,P=new y,se=new y,qt=new y,ne=new C,ge=new ve,De=new y,_e=new y,be=new y,Fe=new y,Ne=new xe,Wt=1e-12,$t=.1;class Jt{constructor(e=1,t=1,s=1){this.radius=new y(e,t,s)}intersectRay(e,t){return ne.makeScale(...this.radius).invert(),ge.center.set(0,0,0),ge.radius=1,Ne.copy(e).applyMatrix4(ne),Ne.intersectSphere(ge,t)?(ne.makeScale(...this.radius),t.applyMatrix4(ne),t):null}constructLatLonFrame(e,t,s){return this.getCartographicToPosition(e,t,0,Fe),this.getCartographicToNormal(e,t,be),this.getNorthernTangent(e,t,_e),De.crossVectors(_e,be),s.makeBasis(De,_e,be).setPosition(Fe)}getNorthernTangent(e,t,s,n=qt){let o=1,i=e+1e-7;e>Math.PI/4&&(o=-1,i=e-1e-7);const a=this.getCartographicToNormal(e,t,P).normalize(),c=this.getCartographicToNormal(i,t,se).normalize();return n.crossVectors(a,c).normalize().multiplyScalar(o),s.crossVectors(n,a).normalize()}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,U);const o=this.radius;P.copy(U),P.x*=o.x**2,P.y*=o.y**2,P.z*=o.z**2;const i=Math.sqrt(U.dot(P));return P.divideScalar(i),n.copy(P).addScaledVector(U,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,P),this.getPositionToNormal(e,U);const s=se.subVectors(e,P);return t.lon=Math.atan2(U.y,U.x),t.lat=Math.asin(U.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Be.set(1,Ht(e),t),s.setFromSpherical(Be).normalize(),jt(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,o=1/s.y**2,i=1/s.z**2,a=e.x*e.x*n,c=e.y*e.y*o,h=e.z*e.z*i,u=a+c+h,l=Math.sqrt(1/u),f=P.copy(e).multiplyScalar(l);if(u<$t)return isFinite(l)?t.copy(f):null;const m=se.set(f.x*n*2,f.y*o*2,f.z*i*2);let d=(1-l)*e.length()/(.5*m.length()),g=0,p,_,T,x,w,v,S,b,L,E,M;do{d-=g,T=1/(1+d*n),x=1/(1+d*o),w=1/(1+d*i),v=T*T,S=x*x,b=w*w,L=v*T,E=S*x,M=b*w,p=a*v+c*S+h*b-1,_=a*L*n+c*E*o+h*M*i;const pt=-2*_;g=p/pt}while(Math.abs(p)>Wt);return t.set(e.x*T,e.y*x,e.z*w)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,o=e*z.DEG2RAD,i=Math.sin(o)**2;return t/Math.sqrt(1-n*i)}getPositionElevation(e){this.getPositionToSurfacePoint(e,P);const t=se.subVectors(e,P);return Math.sign(t.dot(e))*t.length()}}const B=Math.PI,oe=B/2,H=new y,F=new y,N=new y,ke=new C;let q=0;const Te=[];function Qt(r=!1){return r?(Te[q]||(Te[q]=new y),q++,Te[q-1]):new y}function Ve(){q=0}class Zt extends Jt{constructor(e,t,s,n=-oe,o=oe,i=0,a=2*B,c=0,h=0){super(e,t,s),this.latStart=n,this.latEnd=o,this.lonStart=i,this.lonEnd=a,this.heightStart=c,this.heightEnd=h}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:o,heightStart:i,heightEnd:a}=this,c=z.mapLinear(.5,0,1,t,s),h=z.mapLinear(.5,0,1,n,o),u=Math.floor(n/oe)*oe,l=[[-B/2,0],[B/2,0],[0,u],[0,u+B/2],[0,u+B],[0,u+3*B/2],[t,o],[s,o],[t,n],[s,n],[0,n],[0,o],[c,h],[t,h],[s,h],[c,n],[c,o]],f=[],m=l.length;for(let d=0;d<=1;d++){const g=z.mapLinear(d,0,1,i,a);for(let p=0,_=m;p<_;p++){const[T,x]=l[p];if(T>=t&&T<=s&&x>=n&&x<=o){const w=Qt(e);f.push(w),this.getCartographicToPosition(T,x,g,w)}}}return f}getBoundingBox(e,t){Ve();const{latStart:s,latEnd:n,lonStart:o,lonEnd:i}=this;if(n-s<B/2){const h=z.mapLinear(.5,0,1,s,n),u=z.mapLinear(.5,0,1,o,i);this.getCartographicToNormal(h,u,N),F.set(0,0,1),H.crossVectors(F,N),F.crossVectors(H,N),t.makeBasis(H,F,N)}else H.set(1,0,0),F.set(0,1,0),N.set(0,0,1),t.makeBasis(H,F,N);ke.copy(t).invert();const c=this._getPoints(!0);for(let h=0,u=c.length;h<u;h++)c[h].applyMatrix4(ke);e.makeEmpty(),e.setFromPoints(c)}getBoundingSphere(e,t){Ve();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const I=new y,R=new y,O=new y,ze=new y,Ge=new y,je=new y,k=new xe;class Yt{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&(k.copy(e).applyMatrix4(s.inverseTransform),!k.intersectsBox(s.box)))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let o=-1/0,i=-1/0;s&&e.intersectSphere(s,Ge)&&(o=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(Ge)),n&&(k.copy(e).applyMatrix4(n.inverseTransform),k.intersectBox(n.box,je)&&(i=n.box.containsPoint(k.origin)?0:k.origin.distanceToSquared(je)));const a=Math.max(o,i);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,o=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(ze.copy(e).applyMatrix4(s.inverseTransform),o=s.box.distanceToPoint(ze)),n>o?n:o}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new Ue;I.set(e[3],e[4],e[5]),R.set(e[6],e[7],e[8]),O.set(e[9],e[10],e[11]);const n=I.length(),o=R.length(),i=O.length();I.normalize(),R.normalize(),O.normalize(),n===0&&I.crossVectors(R,O),o===0&&R.crossVectors(I,O),i===0&&O.crossVectors(I,R),s.transform.set(I.x,R.x,O.x,e[0],I.y,R.y,O.y,e[1],I.z,R.z,O.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-o,-i),s.box.max.set(n,o,i),s.update(),this.obb=s}setSphereData(e,t,s,n,o){const i=new ve;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(o),this.sphere=i}setRegionData(e,t,s,n,o,i){const a=new Zt(ce,ce,Pt,t,n,e,s,o,i),c=new Ue;a.getBoundingBox(c.box,c.transform),c.update(),this.region=a,this.regionObb=c}}const Xt=new wt;function Kt(r,e,t,s){const n=Xt.set(r.normal.x,r.normal.y,r.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-r.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class es extends xt{constructor(){super(),this.points=Array(8).fill().map(()=>new y)}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,o)=>{Kt(n[0],n[1],n[2],t[o])})}}const He=parseInt($e)<165,ft=Symbol("INITIAL_FRUSTUM_CULLED"),re=new C,ye=new C,V=new y,ts=new y(1,0,0),ss=new y(0,1,0);function qe(r,e){r.traverse(t=>{t.frustumCulled=t[ft]&&e})}class ns extends At{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{qe(t,!e)}))}constructor(...e){super(...e),this.group=new Vt(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this.optimizeRaycast=!0,this._autoDisableRendererCulling=!0,this._eventDispatcher=new vt,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new Lt;if(t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,He){const s=this;this._overridenRaycast=function(n,o){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,o)}}}addEventListener(...e){this._eventDispatcher.addEventListener(...e)}hasEventListener(...e){this._eventDispatcher.hasEventListener(...e)}removeEventListener(...e){this._eventDispatcher.removeEventListener(...e)}dispatchEvent(...e){this._eventDispatcher.dispatchEvent(...e)}getBounds(...e){return console.warn("TilesRenderer: getBounds has been renamed to getBoundingBox."),this.getBoundingBox(...e)}getOrientedBounds(...e){return console.warn("TilesRenderer: getOrientedBounds has been renamed to getOrientedBoundingBox."),this.getOrientedBoundingBox(...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t&&t.getAABB(e),!0}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s&&s.getOBB(e,t),!0}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=ht(this,this.root,e);s&&t.push(s)}else dt(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new Se),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof Se?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{queueMicrotask(()=>{this.dispatchEvent({type:"load-tile-set",tileSet:n,url:e}),this.onLoadTileSet&&this.onLoadTileSet(n,e)})}).catch(()=>{}),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new es,isOrthographic:!1,sseDenominator:-1,position:new y,invScale:-1,pixelSize:0});ye.copy(e.matrixWorld).invert(),V.setFromMatrixScale(ye);const o=V.x;Math.abs(Math.max(V.x-V.y,V.x-V.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,a=n.length;i<a;i++){const c=t[i],h=n[i],u=h.frustum,l=h.position,f=s.get(c);(f.width===0||f.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const m=c.projectionMatrix.elements;if(h.isOrthographic=m[15]===1,h.isOrthographic){const d=2/m[0],g=2/m[5];h.pixelSize=Math.max(g/f.height,d/f.width)}else h.sseDenominator=2/m[5]/f.height;h.invScale=o,re.copy(e.matrixWorld),re.premultiply(c.matrixWorldInverse),re.premultiply(c.projectionMatrix),u.setFromProjectionMatrix(re),l.set(0,0,0),l.applyMatrix4(c.matrixWorld),l.applyMatrix4(ye)}super.update()}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new C;if(e.transform){const a=e.transform;for(let c=0;c<16;c++)n.elements[c]=a[c]}s&&n.premultiply(s.cached.transform);const o=new C().copy(n).invert(),i=new Yt;"sphere"in e.boundingVolume&&i.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&i.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&i.setRegionData(...e.boundingVolume.region),e.cached={loadIndex:0,transform:n,transformInverse:o,active:!1,inFrustum:[],boundingVolume:i,scene:null,geometry:null,materials:null,textures:null}}parseTile(e,t,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const o=t.content.uri.split(/[\\\/]/g);o.pop();const i=o.join("/"),a=this.fetchOptions,c=this.manager,h=t._loadIndex;let u=null;const l=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",f=t.cached,m=f.transform,d=new C;switch(l.toLowerCase()){case"x":d.makeRotationAxis(ss,-Math.PI/2);break;case"y":d.makeRotationAxis(ts,Math.PI/2);break}const g=(G(e)||s).toLowerCase();switch(g){case"b3dm":{const _=new rt(c);_.workingPath=i,_.fetchOptions=a,_.adjustmentTransform.copy(d),u=_.parse(e);break}case"pnts":{const _=new it(c);_.workingPath=i,_.fetchOptions=a,u=_.parse(e);break}case"i3dm":{const _=new at(c);_.workingPath=i,_.fetchOptions=a,_.adjustmentTransform.copy(d),u=_.parse(e);break}case"cmpt":{const _=new Ft(c);_.workingPath=i,_.fetchOptions=a,_.adjustmentTransform.copy(d),u=_.parse(e).then(T=>T.scene);break}case"gltf":case"glb":const p=new kt(c);p.workingPath=i,p.fetchOptions=a,u=p.parse(e);break;default:console.warn(`TilesRenderer: Content type "${g}" not supported.`),u=Promise.resolve(null);break}return u.then(p=>{let _,T;if(p.isObject3D?(_=p,T=null):(_=p.scene,T=p),t._loadIndex!==h)return;_.updateMatrix(),(g==="glb"||g==="gltf")&&_.matrix.multiply(d),_.matrix.premultiply(m),_.matrix.decompose(_.position,_.quaternion,_.scale),_.traverse(S=>{S[ft]=S.frustumCulled}),qe(_,!this.autoDisableRendererCulling),He&&_.traverse(S=>{S.raycast=this._overridenRaycast});const x=[],w=[],v=[];_.traverse(S=>{if(S.geometry&&w.push(S.geometry),S.material){const b=S.material;x.push(S.material);for(const L in b){const E=b[L];E&&E.isTexture&&v.push(E)}}}),f.materials=x,f.geometry=w,f.textures=v,f.scene=_,f.metadata=T,this.dispatchEvent({type:"load-model",scene:_,tile:t}),this.onLoadModel&&this.onLoadModel(_,t)})}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,o=t.textures,i=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,c=n.length;a<c;a++)n[a].dispose();for(let a=0,c=s.length;a<c;a++)s[a].dispose();for(let a=0,c=o.length;a<c;a++){const h=o[a];h.image instanceof ImageBitmap&&h.image.close(),h.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,o=this.group;t?(o.add(s),n.add(e),s.updateMatrixWorld(!0)):(o.remove(s),n.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t}),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,o=this.cameraInfo,i=t.boundingVolume;let a=-1/0,c=1/0;for(let h=0,u=n.length;h<u;h++){if(!s[h])continue;const l=o[h],f=l.invScale;let m;if(l.isOrthographic){const d=l.pixelSize;m=e.geometricError/(d*f)}else{const g=i.distanceToPoint(l.position)*f,p=l.sseDenominator;m=e.geometricError/(g*p),c=Math.min(c,g)}a=Math.max(a,m)}e.__distanceFromCamera=c,e.__error=a}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,o=this.cameraInfo;let i=!1;for(let a=0,c=o.length;a<c;a++){const h=o[a].frustum;s.intersectsFrustum(h)?(i=!0,n[a]=!0):n[a]=!1}return i}}let We=new Je,os=new ve;const cs=r=>{r.update()},ls=(r,e,t,s,n)=>{const o=new ns(t);o.setCamera(r),o.setResolutionFromRenderer(r,e),o.onLoadModel=function(a){a.traverse(c=>{c.isMesh&&(c.material.transparent=!0,c.uniformHigh=rs(c.material,n))})},o.onLoadTileSet=a=>{o.getBounds(We)?(We.getCenter(o.group.position),o.group.position.multiplyScalar(-1)):o.getBoundingSphere(os)&&o.group.position.multiplyScalar(-1)};const i=new we;return i.add(o.group),i.rotation.set(5.5865,0,12.105),s(i),o};function rs(r,e){const t={highlightedBatchId:{value:-1},time:{type:"f",value:0},resolution:{type:"v2",value:new Se(e.clientWidth,e.clientHeight)}};return r.onBeforeCompile=s=>{s.uniforms.highlightedBatchId=t.highlightedBatchId,s.uniforms.time=t.time,s.uniforms.resolution=t.resolution,s.vertexShader=`
			attribute float _batchid;
			varying float batchid;
		`+s.vertexShader.replace(/#include <uv_vertex>/,`
			#include <uv_vertex>
			batchid = _batchid;
			`),s.fragmentShader=`
			varying float batchid;
			uniform float highlightedBatchId;
            uniform float time; 
		`+s.fragmentShader.replace(/vec4 diffuseColor = vec4\( diffuse, opacity \);/,`
			vec4 diffuseColor =
				abs( batchid - highlightedBatchId ) < 0.5 ?
                vec4(0.,0.,0.0,0.0) :
				vec4( diffuse, opacity );
			`)},t}export{cs as T,ls as l};
